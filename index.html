<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Quiz de Imagens</title>
<style>
  :root{
    --bg:#0b0d10;
    --card:#12151a;
    --muted:#a7b0bf;
    --txt:#e8eef6;
    --good:#16a34a;
    --bad:#dc2626;
    --ghost:#2a303b;
    --ring:#1f2937;
    --bar:#60a5fa;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--txt);
    font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  }
  .topbar{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; gap:.75rem;
    padding:.75rem .875rem; background:rgba(18,21,26,.9); backdrop-filter:saturate(1.2) blur(6px);
    border-bottom:1px solid var(--ring);
  }
  .topbar .spacer{flex:1}
  .btn-ghost{
    border:1px solid var(--ghost);
    background:transparent; color:var(--txt);
    padding:.5rem .75rem; border-radius:.5rem; cursor:pointer;
  }
  .btn-ghost.small{padding:.35rem .6rem; font-size:.9rem}
  .progress{flex:1; min-width:0}
  .progress-meta{display:flex; justify-content:flex-end; font-size:.85rem; color:var(--muted); margin-bottom:.25rem}
  .progress-bar{height:6px; background:#11151b; border-radius:999px; overflow:hidden; border:1px solid var(--ring)}
  .progress-bar > .inner{height:100%; width:0%; background:var(--bar); transition:width .25s ease}
  .wrapper{max-width:720px; margin:0 auto; padding:1rem .875rem 6rem}
  .stage{
    display:flex; flex-direction:column; gap:.75rem; min-height:50vh;
    border:1px solid var(--ring); border-radius:.75rem; background:var(--card); padding:.75rem;
  }
  .imgbox{
    position:relative; width:100%; aspect-ratio:1/1; border-radius:.6rem; overflow:hidden;
    background:#0e131a; display:grid; place-items:center;
  }
  .imgbox img{max-width:100%; max-height:100%; width:100%; height:100%; object-fit:cover}
  .overlay-label{
    display:flex; justify-content:space-between; align-items:center; gap:.75rem;
    padding:.25rem .25rem 0;
  }
  .muted{color:var(--muted)}
  #label{font-size:1rem}
  .controls{
    position:fixed; left:0; right:0; bottom:0; z-index:5;
    padding:.875rem; display:flex; gap:.75rem; background:linear-gradient(180deg, rgba(11,13,16,0) 0%, rgba(11,13,16,0.9) 30%, rgba(11,13,16,1) 100%);
    border-top:1px solid var(--ring);
  }
  .btn-good,.btn-bad{
    flex:1; padding:1rem 1rem; border-radius:.75rem; border:0; cursor:pointer; font-weight:600;
  }
  .btn-good{background:var(--good); color:white}
  .btn-bad{background:var(--bad); color:white}
  .btn-good:disabled,.btn-bad:disabled,.btn-ghost:disabled{opacity:.6; cursor:not-allowed}
  .results{display:grid; gap:.75rem; padding:1rem}
  .results h2{margin:.25rem 0}
  .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:.75rem}
  .kpi{background:#0f1319; border:1px solid var(--ring); border-radius:.75rem; padding:.75rem; text-align:center}
  .kpi .val{font-size:1.6rem; font-weight:700}
  .kpi .lab{font-size:.9rem; color:var(--muted)}
  @media (min-width:480px){
    .imgbox{aspect-ratio:4/3}
  }
</style>
</head>
<body>
  <header class="topbar" role="region" aria-label="Barra superior">
    <button id="restartTop" class="btn-ghost small" aria-label="Reiniciar teste">Reiniciar</button>
    <div class="spacer"></div>
    <div class="progress" aria-label="Progresso">
      <div class="progress-meta"><span id="counter">0/10</span></div>
      <div class="progress-bar" aria-hidden="true"><div id="bar" class="inner"></div></div>
    </div>
  </header>

  <main class="wrapper">
    <section class="stage" aria-live="polite" aria-atomic="true">
      <!-- A UI base é montada por JS -->
    </section>
  </main>

  <footer id="controls" class="controls" aria-label="Controles de resposta">
    <!-- Botões são montados por JS -->
  </footer>

  <script src="./images.js"></script>
  <script>
document.addEventListener('DOMContentLoaded', () => {
  // --------- Utilidades ----------
  function shuffle(arr){
    const a = arr.slice();
    for (let i=a.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }
  function preload(srcs){ srcs.forEach(src => { const img = new Image(); img.src = src; }); }

  // --------- Estado ----------
  const state = { order: [], index: 0, right: 0, wrong: 0, revealed: false };

  // Referências fixas do layout
  let counter, bar, restartTop;

  // Referências reconstruídas a cada init()
  let imgbox, labelEl, revealBtn, btnRight, btnWrong;

  function cacheStaticElements(){
    counter = document.getElementById('counter');
    bar = document.getElementById('bar');
    restartTop = document.getElementById('restartTop');

    if(!counter || !bar || !restartTop){
      throw new Error('Estrutura HTML ausente: verifique #counter, #bar, #restartTop.');
    }
    restartTop.addEventListener('click', init);
  }

  function buildBaseUI(){
    const stage = document.querySelector('.stage');
    const controls = document.getElementById('controls');

    stage.innerHTML = `
      <div class="imgbox" id="imgbox"></div>
      <div class="overlay-label">
        <span id="label" class="muted">Toque em “Mostrar nome” se precisar</span>
        <button class="btn-ghost" id="revealBtn" aria-controls="label" aria-expanded="false">Mostrar nome</button>
      </div>
    `;
    controls.innerHTML = `
      <button class="btn-bad" id="btnWrong" aria-label="Marcar como incorreto">Incorreto ✗</button>
      <button class="btn-good" id="btnRight" aria-label="Marcar como correto">Correto ✓</button>
    `;

    imgbox   = document.getElementById('imgbox');
    labelEl  = document.getElementById('label');
    revealBtn= document.getElementById('revealBtn');
    btnRight = document.getElementById('btnRight');
    btnWrong = document.getElementById('btnWrong');

    if(!imgbox || !labelEl || !revealBtn || !btnRight || !btnWrong){
      throw new Error('Estrutura dinâmica ausente: verifique #imgbox, #label, #revealBtn, #btnRight, #btnWrong.');
    }

    revealBtn.addEventListener('click', onRevealToggle);
    btnRight.addEventListener('click', () => mark(true));
    btnWrong.addEventListener('click', () => mark(false));
  }

  function init(){
    buildBaseUI();
    state.order = shuffle(IMAGES);
    state.index = 0;
    state.right = 0;
    state.wrong = 0;
    state.revealed = false;
    preload(state.order.map(i => i.src));
    renderCurrent();
    updateProgress();
    setControlsEnabled(true);
  }

  function setControlsEnabled(enabled){
    btnRight.disabled = !enabled;
    btnWrong.disabled = !enabled;
    revealBtn.disabled = !enabled;
  }

  function updateProgress(){
    const total = state.order.length;
    const current = Math.min(state.index + 1, total);
    counter.textContent = `${state.index < total ? current : total}/${total}`;
    const pct = Math.min((state.index / total) * 100, 100);
    bar.style.width = pct + '%';
  }

  function renderCurrent(){
    if (state.index >= state.order.length) return renderResults();
    const item = state.order[state.index];
    imgbox.innerHTML = '';
    const img = document.createElement('img');
    img.alt = `Item ${state.index + 1} de ${state.order.length}`;
    img.src = item.src;
    imgbox.appendChild(img);

    labelEl.textContent = 'Toque em “Mostrar nome” se precisar';
    labelEl.classList.add('muted');
    state.revealed = false;
    revealBtn.setAttribute('aria-expanded', 'false');
    revealBtn.textContent = 'Mostrar nome';
  }

  function reveal(){
    labelEl.textContent = state.order[state.index].label || '—';
    labelEl.classList.remove('muted');
    state.revealed = true;
    revealBtn.setAttribute('aria-expanded', 'true');
    revealBtn.textContent = 'Ocultar nome';
  }

  function hideReveal(){
    labelEl.textContent = 'Toque em “Mostrar nome” se precisar';
    labelEl.classList.add('muted');
    state.revealed = false;
    revealBtn.setAttribute('aria-expanded', 'false');
    revealBtn.textContent = 'Mostrar nome';
  }

  function onRevealToggle(){ state.revealed ? hideReveal() : reveal(); }

  function mark(isRight){
    if (isRight) state.right++; else state.wrong++;
    state.index++;
    updateProgress();
    state.index >= state.order.length ? renderResults() : renderCurrent();
  }

  function renderResults(){
    setControlsEnabled(false);
    const total = state.order.length;
    const pct = total ? Math.round((state.right / total) * 100) : 0;

    const results = document.createElement('section');
    results.className = 'results';
    results.innerHTML = `
      <h2>Concluído</h2>
      <p class="muted">Resumo do seu desempenho</p>
      <div class="kpis">
        <div class="kpi"><div class="val">${state.right}</div><div class="lab">Corretas</div></div>
        <div class="kpi"><div class="val">${state.wrong}</div><div class="lab">Incorretas</div></div>
        <div class="kpi"><div class="val">${pct}%</div><div class="lab">Precisão</div></div>
      </div>
      <button class="btn-good" id="restartBtn">Reiniciar teste</button>
    `;

    const stage = document.querySelector('.stage');
    stage.innerHTML = '';
    stage.appendChild(results);
    document.getElementById('controls').innerHTML = '';

    const restartBtn = document.getElementById('restartBtn');
    restartBtn.addEventListener('click', init);

    bar.style.width = '100%';
    counter.textContent = `${total}/${total}`;
  }

  // --------- Autotestes opcionais (abra com ?test=1) ----------
  function runTests(){
    const url = new URL(window.location.href);
    const t = url.searchParams.get('test');
    if(!t) return;

    console.info('[TEST] Iniciando testes automáticos...');

    // Teste 1: elementos fixos
    console.assert(document.getElementById('restartTop'), '#restartTop ausente');
    console.assert(document.getElementById('counter'), '#counter ausente');
    console.assert(document.getElementById('bar'), '#bar ausente');
    console.assert(document.querySelector('.stage'), '.stage ausente');
    console.assert(document.getElementById('controls'), '#controls ausente');

    // Teste 2: após init, imagem presente
    console.assert(document.querySelector('#imgbox img'), 'Imagem inicial não renderizada');

    // Teste 3: toggle do revelar
    const before = document.getElementById('label').textContent;
    document.getElementById('revealBtn').click();
    const after = document.getElementById('label').textContent;
    console.assert(before !== after, 'Revelar não alterou o texto do rótulo');

    // Teste 4: avançar uma questão
    const firstSrc = document.querySelector('#imgbox img').src;
    document.getElementById('btnRight').click();
    const secondSrc = document.querySelector('#imgbox img').src;
    console.assert(firstSrc !== secondSrc, 'Clique em correto não avançou para próxima imagem');

    // Teste 5: completar o fluxo
    for(let i=0;i<20;i++){ // garante finalizar, mesmo se já estivermos perto do fim
      const btn = document.getElementById('btnRight');
      if(!btn) break;
      btn.click();
    }
    console.assert(document.querySelector('.results'), 'Tela de resultados não foi exibida');
    console.assert(document.getElementById('restartBtn'), 'Botão Reiniciar (resultados) não existe');

    document.getElementById('restartBtn').click();
    console.assert(document.querySelector('#imgbox img'), 'Após reiniciar, imagem não foi exibida');
    console.info('[TEST] OK');
  }

  cacheStaticElements();
  init();
  runTests();
});
</script>
</body>
</html>
